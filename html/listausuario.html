<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tabla de Datos</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container my-4">
    <h2>Datos de Prestamos</h2>
    <table class="table table-bordered" id="tabla">
        <thead></thead>
        <tbody></tbody>
    </table>
</div>

<!-- Modal para editar -->
<div class="modal fade" id="editarModal" tabindex="-1" aria-labelledby="editarModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editarModalLabel">Editar Descripci贸n</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="filaEditar">
        <div class="mb-3">
          <label for="selectDescripcion" class="form-label">Descripcion</label>
          <select id="selectDescripcion" class="form-select">
            <option value="En uso">En uso</option>
            <option value="Devuelto">Devuelto</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-primary" id="guardarCambio">Guardar</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const SPREADSHEET_ID = "TU_SPREADSHEET_ID";
const RANGE = "prestamosnivel6";
const columnasDeseadas = ["Nombre", "ID", "Equipo", "Descripcion"];

let datosGlobal = [];
let indiceDescripcion = -1;

async function obtenerDatos() {
    const accessToken = sessionStorage.getItem("accessToken");
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}`;
    const res = await fetch(url, {
        headers: { Authorization: `Bearer ${accessToken}` }
    });
    const data = await res.json();
    return data.values || [];
}

function mostrarDatos(datos) {
    datosGlobal = datos;
    const tabla = document.getElementById("tabla");
    const thead = tabla.querySelector("thead");
    const tbody = tabla.querySelector("tbody");

    thead.innerHTML = "";
    tbody.innerHTML = "";

    if (!datos || datos.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8">No hay datos para mostrar</td></tr>';
        return;
    }

    const encabezados = datos[0];
    const indices = columnasDeseadas.map(col => encabezados.indexOf(col));
    indiceDescripcion = encabezados.indexOf("Descripcion");

    const trHead = document.createElement("tr");
    columnasDeseadas.forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        trHead.appendChild(th);
    });
    const thAccion = document.createElement("th");
    thAccion.textContent = "Acci贸n";
    trHead.appendChild(thAccion);
    thead.appendChild(trHead);

    for (let i = 1; i < datos.length; i++) {
        if (datos[i][indiceDescripcion] !== "En uso") continue;
        const tr = document.createElement("tr");
        indices.forEach(idx => {
            const td = document.createElement("td");
            td.textContent = idx >= 0 ? datos[i][idx] || "" : "";
            tr.appendChild(td);
        });

        const tdAccion = document.createElement("td");
        const btn = document.createElement("button");
        btn.textContent = "Editar";
        btn.className = "btn btn-sm btn-primary";
        btn.onclick = () => abrirModal(i);
        tdAccion.appendChild(btn);
        tr.appendChild(tdAccion);

        tbody.appendChild(tr);
    }
}

function abrirModal(fila) {
    document.getElementById("filaEditar").value = fila;
    const valorActual = datosGlobal[fila][indiceDescripcion] || "En uso";
    document.getElementById("selectDescripcion").value = valorActual;
    const modal = new bootstrap.Modal(document.getElementById("editarModal"));
    modal.show();
}

document.getElementById("guardarCambio").onclick = async () => {
    const fila = parseInt(document.getElementById("filaEditar").value);
    const nuevoValor = document.getElementById("selectDescripcion").value;

    const accessToken = sessionStorage.getItem("accessToken");
    if (!accessToken) {
        alert("No hay sesi贸n activa. Inicie sesi贸n de nuevo.");
        return;
    }

    const rangoCelda = `prestamosnivel6!${String.fromCharCode(65 + indiceDescripcion)}${fila + 1}`;
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${rangoCelda}?valueInputOption=USER_ENTERED`;

    const res = await fetch(url, {
        method: "PUT",
        headers: {
            Authorization: `Bearer ${accessToken}`,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            range: rangoCelda,
            majorDimension: "ROWS",
            values: [[nuevoValor]]
        })
    });

    if (res.ok) {
        datosGlobal[fila][indiceDescripcion] = nuevoValor;
        mostrarDatos(datosGlobal);
        bootstrap.Modal.getInstance(document.getElementById("editarModal")).hide();
    } else {
        const err = await res.json();
        console.error("Error al actualizar:", err);
        alert("No se pudo actualizar en la hoja. Revisa permisos de Google Sheets API.");
    }
};

obtenerDatos().then(mostrarDatos);
</script>
</body>
</html>
