<form id="usuarioForm" class="needs-validation" novalidate>
    <div class="card-title mb-0">
        <h6 class="m-0 me-2">Registro de usuario Nivel 6</h6>
    </div>
    <br>

    <div class="row mb-4">
        <!--Fecha-->
        <div class="col">
            <div class="form-outline">
                <label class="form-label" style="font-size: 12px;" for="fecha">Fecha</label>
                <input type="date" id="fecha" name="fecha" class="form-control" required>
            </div>
        </div>
        <!--Usuario-->
        <div class="col">
            <div class="form-outline">
                <label class="form-label" style="font-size: 12px;" for="nombreUsuario1">Nombre Apellidos</label>
                <input type="text" id="nombreUsuario1" name="nombreUsuario1" class="form-control">
                <div class="invalid-feedback">Ingrese el usuario</div>
            </div>
        </div>
        <!--Visita-->
        <div class="col">
            <div class="form-outline">
                <label class="form-label" style="font-size: 12px;" for="nacionalidad1">Visita</label>
                <select id="nacionalidad1" name="nacionalidad1" class="form-control">
                    <option value="" disabled selected>Seleccionar</option>
                    <?php foreach ($data['nacionalidades'] as $visita): ?>
                        <option value="<?php echo htmlspecialchars($visita['idTipovisita']); ?>">
                            <?php echo htmlspecialchars($visita['estado']); ?>
                        </option>
                    <?php endforeach; ?>
                </select>
            </div>
        </div>
        <!--Entidad-->
        <div id="opcionesNacional" class="col" style="display:none;">
            <div class="form-outline">
                <label class="form-label" style="font-size: 12px;" for="tipoEntidad">Tipo de Entidad</label>
                <select id="tipoEntidad" name="tipoEntidad" class="form-control">
                    <option value="" disabled selected>Seleccionar</option>
                    <?php foreach ($data['entidad'] as $entidad): ?>
                        <option value="<?php echo htmlspecialchars($entidad['idEntidad']); ?>">
                            <?php echo htmlspecialchars($entidad['entidad']); ?>
                        </option>
                    <?php endforeach; ?>
                </select>
            </div>
        </div>
        <!--Opción Extranjero-->
        <div id="opcionExtranjero" class="col" style="display:none;">
            <div class="form-outline">
                <label class="form-label" style="font-size: 12px;" for="paisExtranjero">País</label>
                <input type="text" id="paisExtranjero" class="form-control" placeholder="Escriba su país">
            </div>
        </div>
        <!--Lugar visita-->
        <div id="lugarVisita" class="col" style="display:none;">
            <div class="form-outline">
                <label class="form-label" style="font-size: 12px;" for="lugar">Lugar de Visita</label>
                <input type="text" id="lugar" class="form-control" placeholder="Escriba el lugar de visita" required>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <!--Documento-->
        <div class="col">
            <div class="form-outline">
                <label class="form-label" style="font-size: 12px;" for="tipoDocu">Documento</label>
                <select id="tipoDocu" name="tipoDocu" class="form-control">
                    <option value="" disabled selected>Seleccionar</option>
                    <?php foreach ($data['documentos'] as $document): ?>
                        <option value="<?php echo htmlspecialchars($document['idDocu']); ?>">
                            <?php echo htmlspecialchars($document['tipo']); ?>
                        </option>
                    <?php endforeach; ?>
                </select>
            </div>
        </div>
        <!--Número Documento-->
        <div class="col" id="numdocumento1" style="display:none;">
            <div class="form-outline">
                <label class="form-label" style="font-size: 12px;" for="numDocu1">N° Documento</label>
                <input type="text" id="numDocu1" class="form-control">
            </div>
        </div>
        <!--Género-->
        <div class="col">
            <div class="form-outline">
                <label class="form-label" style="font-size: 12px;" for="genero1">Género</label>
                <select id="genero1" name="genero1" class="form-control">
                    <option value="" disabled selected>Seleccionar</option>
                    <?php foreach ($data['genero'] as $generos): ?>
                        <option value="<?php echo htmlspecialchars($generos['idgenero']); ?>">
                            <?php echo htmlspecialchars($generos['genero']); ?>
                        </option>
                    <?php endforeach; ?>
                </select>
            </div>
        </div>
        <!--Edad-->
        <div class="col">
            <div class="form-outline">
                <label class="form-label" style="font-size: 12px;" for="edad1">Edad</label>
                <input type="number" id="edad1" class="form-control" min="7">
            </div>
        </div>
    </div>

    <!--Botón de agregar usuarios-->
    <div class="row mb-4">
        <div class="col-12">
            <button type="button" class="btn btn-primary" id="agregarUsuario">Agregar Usuario</button>
        </div>
    </div>


    <div class="row mb-4">
        <div class="col">
            <div class="table-responsive">
                <table class="table table-bordered" id="tablaUsuarios">
                    <thead class="alert-info">
                        <tr style="background-color: blue; color: white;">
                            <th>Fecha</th>
                            <th>Usuario</th>
                            <th>Visita</th>
                            <th>Entidad</th>
                            <th>Documento</th>
                            <th>Edad</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Filas generadas dinámicamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!--Procesar Usuario-->
    <div class="row mb-4">
        <div class="col-12">
            <button type="button" class="btn btn-secondary" id="guardarCambios">Guardar Cambios y Enviar</button>
        </div>
    </div>
</form>

<!-- Modal -->
<div class="modal fade" id="modalOpciones" tabindex="-1" aria-labelledby="modalOpcionesLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalOpcionesLabel">Asignación de equipo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="modalForm">
                    <input type="hidden" id="fechaActual" name="fehap" value="<?php echo date('Y-m-d'); ?>">

                    <div class="row mb-4">
                        <div class="col">
                            <div class="form-outline">
                                <label class="form-label" for="consola">Consola</label>
                                <select id="consola" name="consola" class="form-control">
                                    <option value="" disabled selected>Seleccionar</option>
                                    <?php foreach ($data['consolas'] as $consol): ?>
                                        <option value="<?php echo htmlspecialchars($consol['idTipoconsola']); ?>">
                                            <?php echo htmlspecialchars($consol['detalle']); ?>
                                            <?php echo htmlspecialchars($consol['consola']); ?>
                                        </option>
                                    <?php endforeach; ?>
                                </select>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-outline">
                                <label class="form-label" for="tiempoJuego">Tiempo de juego</label>
                                <input type="number" id="tiempoJuego" name="tiempoJuego" class="form-control" required>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-outline">
                                <label class="form-label" for="inicio">Inicio</label>
                                <input type="time" id="inicio" name="inicio" class="form-control" required>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-outline">
                                <label class="form-label" for="finalizacion">Finalización</label>
                                <input type="time" id="finalizacion" name="finalizacion" class="form-control" required>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-4">
                        <div class="col">
                            <div class="form-outline">
                                <label class="form-label" for="estado">Estado</label>
                                <select id="estado" name="estado" class="form-control">
                                    <option value="" disabled selected>Seleccionar</option>
                                    <?php foreach ($data['estadoUsuario'] as $estado): ?>
                                        <option value="<?php echo htmlspecialchars($estado['idestado']); ?>">
                                            <?php echo htmlspecialchars($estado['estado']); ?>
                                        </option>
                                    <?php endforeach; ?>
                                </select>

                            </div>
                        </div>
                        <div class="col">
                            <div class="form-outline">
                                <label class="form-label" for="turnos">Colocado Por</label>
                                <select id="integrantes" name="integrantes" class="form-control">
                                    <option value="" disabled selected>Seleccionar</option>
                                    <?php foreach ($data['grupo'] as $horarios): ?>
                                        <option value="<?php echo htmlspecialchars($horarios['id']); ?>">
                                            <?php

                                            echo htmlspecialchars($horarios['nombre']) . ' ' . htmlspecialchars($horarios['apellido']);
                                            ?>
                                        </option>
                                    <?php endforeach; ?>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancelarBtn">Cancelar</button>
                <button type="button" class="btn btn-primary" id="enviarDatos">Enviar</button>
            </div>
        </div>
    </div>
</div>



<script src="/mvcPrueba/public/js/obtenerHora.js"></script>
<script src="/mvcPrueba/public/js/obtenerpais.js"></script>
<script src="/mvcPrueba/public/js/validacionNacional.js"></script>
<script src="/mvcPrueba/public/js/tiempojuego.js"></script>
<script src="/mvcPrueba/public/js/validacionNum.js"></script>
<script src="/mvcPrueba/public/js/fechaactual.js"></script>
<script src="/mvcPrueba/public/js/letra_numero.js"></script>
<script src="/mvcPrueba/public/js/edad.js"></script>



<!--- Metodo para procesar formulario y vista previa --->
<script>
    let usuarios = [];

    //Vista previa
    const entidadesMap = {
        1: 'Particular',
        2: 'Gobierno',
        3: 'Institucional',
        4: 'Pueblos Originarios'
    };
    const visitamap = {
        1: 'Nacional',
        2: 'Extranjero'
    };
    const documap = {
        1: 'Llave del Saber',
        2: 'Dui',
        3: 'Otros'
    };

    // Función para agregar usuario
    document.getElementById('agregarUsuario').addEventListener('click', function() {
        const fechaInput = document.getElementById('fecha');
        const fecha = fechaInput.value;
        const usuario = document.getElementById('nombreUsuario1').value;
        const visita = document.getElementById('nacionalidad1').value;
        const entidad = document.getElementById('tipoEntidad').value;
        const extranjero = document.getElementById('paisExtranjero').value;
        const lugarVisita = document.getElementById('lugar').value;

        const documento = document.getElementById('tipoDocu').value;
        const numDocumento = document.getElementById('numDocu1').value || '';
        const genero = document.getElementById('genero1').value;
        const edad = document.getElementById('edad1').value;

        const nivel = 2;

        // Verificar si todos los campos necesarios están completos
        if (usuario && visita && documento && genero && edad &&
            ((visita === "1" && entidad) || (visita === "2" && extranjero)) &&
            ((documento === "1" || documento === "2") ? numDocumento : true)) {
            if (usuarios.length < 5) {
                usuarios.push({
                    fecha,
                    usuario,
                    visita,
                    entidad,
                    extranjero,
                    lugarVisita,
                    documento,
                    numDocumento,
                    genero,
                    edad,
                    nivel
                });

                // Limpiar la tabla antes de agregar las filas
                document.querySelector("#tablaUsuarios tbody").innerHTML = '';

                // Actualizar la tabla con los usuarios agregados
                usuarios.forEach((u, index) => {
                    const entidadTexto = entidadesMap[u.entidad] || 'No especificado';
                    const visitaM = visitamap[u.visita] || 'No especificado';
                    const docuM = documap[u.documento] || 'No especificado';

                    const fila = `<tr>
                    <td>${u.fecha}</td>
                    <td>${u.usuario}</td>
                    <td>${visitaM}</td>
                    <td>${entidadTexto}</td>
                    <td>${docuM}</td>
                    <td>${u.edad}</td>
                    <td><button type="button" class="btn btn-danger" onclick="eliminarUsuario(${index})">Eliminar</button></td>
                </tr>`;
                    document.querySelector("#tablaUsuarios tbody").insertAdjacentHTML('beforeend', fila);
                });

                // Limpiar los campos del formulario
                document.getElementById('usuarioForm').reset();
                fechaInput.value = fecha;

                document.getElementById('opcionesNacional').style.display = 'none';
                document.getElementById('opcionExtranjero').style.display = 'none';
                document.getElementById('lugarVisita').style.display = 'none';
                document.getElementById('numdocumento1').style.display = 'none';

            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'Solo puedes agregar un máximo de 5 usuarios.',
                    confirmButtonText: 'Aceptar'
                });
            }
        } else {
            Swal.fire({
                icon: 'warning',
                title: 'Campos incompletos',
                text: 'Por favor, completa todos los campos.',
                confirmButtonText: 'Aceptar'
            });
        }
    });

    // Función para eliminar un usuario de la tabla y del array
    function eliminarUsuario(index) {
        usuarios.splice(index, 1);
        document.querySelector("#tablaUsuarios tbody").innerHTML = '';

        usuarios.forEach((u, i) => {
            const entidadTexto = entidadesMap[u.entidad] || 'No especificado';
            const visitaM = visitamap[u.visita] || 'No especificado';
            const docuM = documap[u.documento] || 'No especificado';

            const fila = `<tr>
            <td>${u.fecha}</td>
            <td>${u.usuario}</td>
            <td>${visitaM}</td>
            <td>${entidadTexto}</td>
            <td>${docuM}</td>
            <td>${u.edad}</td>
            <td><button type="button" class="btn btn-danger" onclick="eliminarUsuario(${i})">Eliminar</button></td>
        </tr>`;
            document.querySelector("#tablaUsuarios tbody").insertAdjacentHTML('beforeend', fila);
        });
    }

    // Mostrar el modal solo si hay entre 1 y 5 usuarios
    document.getElementById('guardarCambios').addEventListener('click', function() {
        if (usuarios.length === 0) {
            Swal.fire({
                icon: 'warning',
                title: 'No se puede guardar',
                text: 'Debes agregar al menos un usuario antes de guardar.',
                confirmButtonText: 'Aceptar'
            });
        } else {
            const modal = new bootstrap.Modal(document.getElementById('modalOpciones'));
            modal.show();
        }
    });

    // Enviar los datos al servidor
    document.getElementById('enviarDatos').addEventListener('click', function() {
        const modalForm = document.getElementById('modalForm');
        const formData = new FormData(modalForm);

        // Agregar los datos de los usuarios al FormData
        usuarios.forEach((u, index) => {
            for (const [key, value] of Object.entries(u)) {
                formData.append(`${key}${index + 1}`, value);
            }
        });

        fetch('/mvcPrueba/?route=usuarioAgregar', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Guardado',
                        text: data.message,
                        confirmButtonText: 'Aceptar'
                    }).then(() => {
                        window.location.href = '/mvcPrueba/?route=usuario';
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.message,
                        confirmButtonText: 'Aceptar'
                    });
                }
            })
            .catch(error => {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Ocurrió un error al enviar los datos.',
                    confirmButtonText: 'Aceptar'
                });
            });
    });
</script>
