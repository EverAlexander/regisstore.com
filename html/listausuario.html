<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8">
  <title>Lista de Pr√©stamos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
  <div class="container mt-4">
    <h1 class="h3 mb-4 text-gray-800">Lista de Pr√©stamos</h1>

    <div class="mb-3">
      <a href="agregarPrestamos.html" class="btn btn-success">‚ûï Agregar Pr√©stamo</a>
    </div>

    <div class="card shadow mb-4">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-bordered" id="tabla">
            <thead class="thead-light"></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="editarModal" tabindex="-1" aria-labelledby="editarLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editarLabel">Editar Descripci√≥n</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="formEditar">
            <div class="mb-3">
              <label for="selectDescripcion" class="form-label">Descripci√≥n:</label>
              <select class="form-select" id="selectDescripcion">
                <option value="En uso">En uso</option>
                <option value="Finalizo">Finalizo</option>
                <option value="Reservado">Reserbado</option>
              </select>
            </div>
            <input type="hidden" id="filaEditar">
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="guardarCambio">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const SPREADSHEET_ID = "1jcP5Kwh903YSN4sXV4CCC6EAUOwxM1rTmk339Evlh-I";
    const RANGE = "prestamosnivel6!A1:Z1000";

    const columnasDeseadas = [
      "Tipo documento",
      "Num documento",
      "Nombre completo",
      "Lugar de estudio",
      "Prestamo de",
      "Estado",
      "Descripcion"
    ];

    let datosGlobal = [];
    let indiceDescripcion = -1;

    async function obtenerDatos() {
      const accessToken = sessionStorage.getItem("accessToken"); // üîë usamos token de login
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}`;
      const res = await fetch(url, {
        headers: { Authorization: `Bearer ${accessToken}` }
      });
      const data = await res.json();
      return data.values || [];
    }

    function mostrarDatos(datos) {
      datosGlobal = datos;
      const tabla = document.getElementById("tabla");
      const thead = tabla.querySelector("thead");
      const tbody = tabla.querySelector("tbody");

      thead.innerHTML = "";
      tbody.innerHTML = "";

      if (!datos || datos.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8">No hay datos para mostrar</td></tr>';
        return;
      }

      const encabezados = datos[0];
      const indices = columnasDeseadas.map(col => encabezados.indexOf(col));
      indiceDescripcion = encabezados.indexOf("Descripcion");

      const trHead = document.createElement("tr");
      columnasDeseadas.forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        trHead.appendChild(th);
      });
      const thAccion = document.createElement("th");
      thAccion.textContent = "Acci√≥n";
      trHead.appendChild(thAccion);
      thead.appendChild(trHead);

      for (let i = 1; i < datos.length; i++) {
        const tr = document.createElement("tr");
        indices.forEach(idx => {
          const td = document.createElement("td");
          td.textContent = idx >= 0 ? datos[i][idx] || "" : "";
          tr.appendChild(td);
        });

        const tdAccion = document.createElement("td");
        const btn = document.createElement("button");
        btn.textContent = "Editar";
        btn.className = "btn btn-sm btn-primary";
        btn.onclick = () => abrirModal(i);
        tdAccion.appendChild(btn);
        tr.appendChild(tdAccion);

        tbody.appendChild(tr);
      }
    }

    function abrirModal(fila) {
      document.getElementById("filaEditar").value = fila;
      const valorActual = datosGlobal[fila][indiceDescripcion];
      document.getElementById("selectDescripcion").value = valorActual || "Otro";
      const modal = new bootstrap.Modal(document.getElementById("editarModal"));
      modal.show();
    }

    document.getElementById("guardarCambio").onclick = async () => {
      const fila = parseInt(document.getElementById("filaEditar").value);
      const nuevoValor = document.getElementById("selectDescripcion").value;

      const accessToken = sessionStorage.getItem("accessToken"); // üîë
      if (!accessToken) {
        alert("No hay sesi√≥n activa. Inicie sesi√≥n de nuevo.");
        return;
      }

      const rangoCelda = `prestamosnivel6!${String.fromCharCode(65 + indiceDescripcion)}${fila + 1}`;

      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${rangoCelda}?valueInputOption=USER_ENTERED`;

      const res = await fetch(url, {
        method: "PUT",
        headers: {
          Authorization: `Bearer ${accessToken}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          range: rangoCelda,
          majorDimension: "ROWS",
          values: [[nuevoValor]]
        })
      });

      if (res.ok) {
        datosGlobal[fila][indiceDescripcion] = nuevoValor;
        mostrarDatos(datosGlobal);
        bootstrap.Modal.getInstance(document.getElementById("editarModal")).hide();
      } else {
        const err = await res.json();
        console.error("Error al actualizar:", err);
        alert("No se pudo actualizar en la hoja. Revisa permisos de Google Sheets API.");
      }
    };

    obtenerDatos().then(mostrarDatos);
  </script>
</body>
</html>
