<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Reservaciones Cambiales</title>
    <link href="https://fonts.googleapis.com/css?family=Nunito:200,300,400,600,700,800,900" rel="stylesheet">
    <link href="../css/sb-admin-2.min.css" rel="stylesheet">
    <link href="../css/estilo.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script>
        function actualizarHora() {
            const ahora = new Date();
            const horas = ahora.getHours().toString().padStart(2, '0');
            const minutos = ahora.getMinutes().toString().padStart(2, '0');
            const segundos = ahora.getSeconds().toString().padStart(2, '0');
            document.getElementById('horaActual').textContent = `${horas}:${minutos}:${segundos}`;
        }
        setInterval(actualizarHora, 1000);
    </script>
</head>
<body id="page-top">
<div id="wrapper">
    <!-- Sidebar igual que el original -->
    <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">
        <!-- Contenido sidebar igual -->
    </ul>

    <div id="content-wrapper" class="d-flex flex-column">
        <div id="content">
            <div class="container-fluid">
                <div class="d-sm-flex align-items-center justify-content-between mb-4">
                    <div class="h5 mb-0 font-weight-bold text-gray-800"><span id="horaActual"></span></div>
                    <div class="dropdown">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <img id="userImage" src="" alt="Imagen de usuario" class="user-logo rounded-circle" width="50" height="40">
                        </a>
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="userDropdown">
                            <span class="dropdown-item"><i class="fas fa-user mr-2"></i><span id="userName"></span></span>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="#" id="logoutBtn"><i class="fas fa-sign-out-alt mr-2"></i> Cerrar Sesión</a>
                        </div>
                    </div>
                </div>

                <div class="card shadow mb-4">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered" id="tabla">
                                <thead class="thead-light"></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Modal igual que original -->
                <div class="modal fade" id="editarModal" tabindex="-1" aria-labelledby="editarLabel" aria-hidden="true">
                    <!-- contenido modal igual -->
                </div>
            </div>
        </div>

        <footer class="sticky-footer bg-white">
            <div class="container my-auto">
                <div class="copyright text-center my-auto">
                    © <script>document.write(new Date().getFullYear());</script>, The_Alexander
                </div>
            </div>
        </footer>
    </div>
</div>

<!-- Scripts similares al original -->
<script src="../public/vendor/jquery/jquery.min.js"></script>
<script src="../public/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="../public/vendor/jquery-easing/jquery.easing.min.js"></script>
<script src="../public/js/sb-admin-2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>

<script>
    const SPREADSHEET_ID = "1jcP5Kwh903YSN4sXV4CCC6EAUOwxM1rTmk339Evlh-I";
    const RANGE = "prestamosnivel6!A1:Z1000";
    const columnasDeseadas = ["Tipo documento","Num documento","Nombre completo","Lugar de estudio","Prestamo de","Estado","Descripcion"];
    let datosGlobal = [];
    let indiceDescripcion = -1;

    async function obtenerDatos() {
        const accessToken = sessionStorage.getItem("accessToken");
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}`;
        const res = await fetch(url, { headers: { Authorization: `Bearer ${accessToken}` }});
        const data = await res.json();
        return data.values || [];
    }

    function mostrarDatos(datos) {
        datosGlobal = datos;
        const tabla = document.getElementById("tabla");
        const thead = tabla.querySelector("thead");
        const tbody = tabla.querySelector("tbody");
        thead.innerHTML = "";
        tbody.innerHTML = "";

        if (!datos || datos.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8">No hay datos para mostrar</td></tr>';
            return;
        }

        const encabezados = datos[0];
        const indices = columnasDeseadas.map(col => encabezados.indexOf(col));
        indiceDescripcion = encabezados.indexOf("Descripcion");

        const trHead = document.createElement("tr");
        columnasDeseadas.forEach(h => {
            const th = document.createElement("th");
            th.textContent = h;
            trHead.appendChild(th);
        });
        const thAccion = document.createElement("th"); thAccion.textContent = "Acción"; trHead.appendChild(thAccion);
        thead.appendChild(trHead);

        // FILTRO SOLO RESERVADO
        const datosFiltrados = datos.slice(1).filter(fila => fila[indiceDescripcion] === "Reservado");

        if (datosFiltrados.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8">No hay registros "Reservado"</td></tr>';
            return;
        }

        datosFiltrados.forEach((fila,index)=>{
            const tr=document.createElement("tr");
            indices.forEach(idx=>{ const td=document.createElement("td"); td.textContent=idx>=0?fila[idx]||"":"";
            tr.appendChild(td);
            });
            const tdAccion=document.createElement("td");
            const btn=document.createElement("button"); btn.textContent="Editar"; btn.className="btn btn-sm btn-primary";
            btn.onclick=()=>abrirModal(index+1); tdAccion.appendChild(btn); tr.appendChild(tdAccion);
            tbody.appendChild(tr);
        });
    }

    function abrirModal(fila) {
        document.getElementById("filaEditar").value = fila;
        const valorActual = datosGlobal[fila][indiceDescripcion];
        document.getElementById("selectDescripcion").value = valorActual || "Otro";
        const modal = new bootstrap.Modal(document.getElementById("editarModal"));
        modal.show();
    }

    document.getElementById("guardarCambio").onclick = async () => {
        const fila = parseInt(document.getElementById("filaEditar").value);
        const nuevoValor = document.getElementById("selectDescripcion").value;
        const accessToken = sessionStorage.getItem("accessToken");
        const rangoCelda = `prestamosnivel6!${String.fromCharCode(65+indiceDescripcion)}${fila+1}`;
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${rangoCelda}?valueInputOption=USER_ENTERED`;

        const res = await fetch(url, { method:"PUT", headers:{Authorization:`Bearer ${accessToken}`,"Content-Type":"application/json"}, body:JSON.stringify({range:rangoCelda,majorDimension:"ROWS",values:[[nuevoValor]]})});
        if(res.ok){ datosGlobal[fila][indiceDescripcion]=nuevoValor; mostrarDatos(datosGlobal); bootstrap.Modal.getInstance(document.getElementById("editarModal")).hide(); }
        else{ const err=await res.json(); alert("No se pudo actualizar en la hoja"); console.error(err);}
    };

    // Cargar datos
    obtenerDatos().then(mostrarDatos);
</script>
</body>
</html>
